<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Create a time slider</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css" rel="stylesheet" />
<script src='csv2geojson.js'></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<style>
    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        position: absolute;
        width: 25%;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay h2 {
        line-height: 24px;
        display: block;
        margin: 0 0 10px;
    }

    .map-overlay .legend .bar {
        height: 10px;
        width: 100%;
        background: linear-gradient(to right, #fca107, #7f3121);
    }

    .map-overlay input {
        background-color: transparent;
        display: inline-block;
        width: 100%;
        position: relative;
        margin: 0;
        cursor: ew-resize;
    }
</style>

<div id="map"></div>

<!-- <div class="map-overlay top">
    <div class="map-overlay-inner">
        <h2>Significant earthquakes in 2015</h2>
        <label id="month"></label>
        <input id="slider" type="range" min="0" max="11" step="1" value="0" />
    </div>
    <div class="map-overlay-inner">
        <div id="legend" class="legend">
            <div class="bar"></div>
            <div>Magnitude (m)</div>
        </div>
    </div> -->
</div>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
	mapboxgl.accessToken = 'pk.eyJ1Ijoic21hbGxtdWx0aXBsZXMiLCJhIjoiRk4xSUp6OCJ9.GilBdBaV0oKMZgBwBqRMWA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/smallmultiples/ckamk1c0w2yvz1in016tevsuu',
        center: [154.91, 24.47],
        zoom: 1
    });

    map.on('load', function() {
        // BASE LAYER: COVID Choropleth
        d3.json(
            'BASELINE-COVID19.geojson',
            function(err, data) {
                if (err) throw err;

                var layers = map.getStyle().layers;
                // Find the index of the first symbol layer in the map style
                var firstSymbolId;
                for (var i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol') {
                    firstSymbolId = layers[i].id;
                    break;
                    }
                }
                
                // Filter date: only use latest
                data.features = data.features.filter(function(d) {
                    return d.properties['BASELINE-COVID19_Date_reported'] == "24\/5\/2020 12:00:00 AM";
                })

                // Convert to integer
                data.features.map(function(d) {
                    d.properties['BASELINE-COVID19_Cumulative_deaths'] = parseInt(d.properties['BASELINE-COVID19_Cumulative_deaths']);
                })

                map.addSource('countries', {
                    'type': 'geojson',
                    data: data
                });

                map.addLayer({
                    'id': 'covid-baselayer',
                    'type': 'fill',
                    'source': 'countries',
                    'paint': {
                        // 'fill-color': getColor(feature.properties.COVID19_Cumulative_deaths),
                        'fill-opacity': 0.7,
                        'fill-outline-color': '#fff',
                        'fill-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'BASELINE-COVID19_Cumulative_deaths'],
                            0,
                            '#f0f0f0',
                            2500,
                            '#d9d9d9',
                            5000,
                            '#bdbdbd',
                            10000,
                            '#969696',
                            20000,
                            '#737373',
                            50000,
                            '#525252',
                            100000,
                            '#252525'
                        ]
                    }
                }, firstSymbolId);

            }
        );

        // INDICATOR LAYER:
        d3.csv(
            'HEALTH-beds_physicians_nurses.csv',
            function(err, csvData) {
                if (err) throw err;
                console.log(csvData);
                csv2geojson.csv2geojson(csvData, {
                    latfield: 'Latitude (average)',
                    lonfield: 'Longitude (average)',
                    delimiter: ','
                }, function(err, data) {
                    // Convert to integer
                    data.features.map(function(d) {
                        d.properties['Hospital beds'] = parseInt(d.properties['Hospital beds']);
                    })
                    map.addLayer({
                        'id': 'beds',
                        'type': 'circle',
                        'source': {
                            'type': 'geojson',
                            'data': data
                        },
                        'paint': {
                            'circle-color': '#346BA7',
                            'circle-radius': [
                                'interpolate',
                                ['linear'],
                                ['get', 'Hospital beds'],
                                0,
                                1,
                                10,
                                5,
                                20,
                                10,
                                30,
                                10,
                                40,
                                10,
                                50,
                                10,
                                60,
                                15,
                                70,
                                15,
                                80,
                                15,
                                90,
                                15,
                                100,
                                20,
                                110,
                                20,
                                120,
                                20,
                                130,
                                20,
                                140,
                                25,
                                150,
                                25
                            ]
                        }
                    });
                });
            }
        )

        // When a click event occurs on a feature in the places layer, open a popup at the
        // location of the feature, with description HTML from its properties.
        map.on('click', 'beds', function(e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties['Country'] + ' has ' + e.features[0].properties['Hospital beds'] + ' beds per 10,000 people';
             
            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
         
            new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
        });
         
        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'beds', function() {
            map.getCanvas().style.cursor = 'pointer';
        });
         
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'beds', function() {
            map.getCanvas().style.cursor = '';
        });

        // When a click event occurs on a feature in the places layer, open a popup at the
        // location of the feature, with description HTML from its properties.
        map.on('click', 'covid-baselayer', function(e) {
            var coordinates = e.lngLat;
            var description = e.features[0].properties['ADMIN'] + ' so far has ' + e.features[0].properties['BASELINE-COVID19_Cumulative_deaths'] + ' COVID-19 caused deaths';
             
            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
         
            new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
        });
         
        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'covid-baselayer', function() {
            map.getCanvas().style.cursor = 'pointer';
        });
         
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'covid-baselayer', function() {
            map.getCanvas().style.cursor = '';
        });

    });
</script>

</body>
</html>